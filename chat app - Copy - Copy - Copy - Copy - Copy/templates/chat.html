<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Chat</title>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body{margin:0;font-family:Arial;height:100vh;display:flex;background:#e5ddd5}
  .sidebar{width:260px;background:#fff;border-right:1px solid #ccc;display:flex;flex-direction:column}
  .sidebar-header{background:#075e54;color:#fff;padding:15px;text-align:center;font-weight:bold}
  #userList{flex:1;overflow:auto;padding:0;margin:0;list-style:none}
  #userList li{padding:12px;display:flex;align-items:center;border-bottom:1px solid #f0f0f0;cursor:pointer}
  #userList li:hover{background:#f6f6f6}
  .user-avatar{width:36px;height:36px;border-radius:50%;margin-right:10px;display:inline-block;background:#ccc;color:#fff;text-align:center;line-height:36px;font-weight:bold}
  .user-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover}
  .chatbox{flex:1;display:flex;flex-direction:column}
  .chat-header{background:#075e54;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
  #messages{flex:1;padding:15px;overflow:auto;display:flex;flex-direction:column;background:#e5ddd5}
  .message-container{display:flex;align-items:flex-end;margin:6px 0}
  .message-container.self{flex-direction:row-reverse}
  .msg{padding:10px 14px;border-radius:12px;max-width:60%;font-size:14px}
  .msg.self{background:#dcf8c6}
  .msg.other{background:#fff}
  .timestamp{font-size:11px;color:#666;margin-top:6px;text-align:right}
  #messageForm{display:flex;padding:10px;background:#f0f0f0;border-top:1px solid #ccc;align-items:center}
  #messageInput{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;outline:none}
  #emojiBtn{margin-left:8px;cursor:pointer;font-size:20px;background:none;border:none}
  #emojiPicker{position:absolute;bottom:70px;left:300px;background:#fff;border-radius:8px;padding:8px;display:none;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
  .emoji{font-size:20px;padding:6px;cursor:pointer}
  button.send{margin-left:10px;padding:10px 16px;border:none;border-radius:20px;background:#075e54;color:#fff;cursor:pointer}
</style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">Online Users</div>
    <ul id="userList"></ul>
  </div>

  <div class="chatbox">
    <div class="chat-header">
      <div id="chatWith">Select a user to chat</div>
      <div>
        <a href="{{ url_for('profile') }}" style="color:white;text-decoration:none"><i class="fa fa-cog"></i></a>
      </div>
    </div>

    <div id="messages"></div>

    <form id="messageForm">
      <input id="messageInput" autocomplete="off" placeholder="Type a message..." />
      <button id="emojiBtn" type="button">😊</button>
      <button class="send" type="submit">Send</button>
    </form>

    <div id="emojiPicker"></div>
  </div>

<script>
const socket = io({ transports: ["websocket", "polling"] });
const username = "{{ username }}";
const allUsers = {{ users|tojson }};
let currentChatUser = null;

// Register user once connected
socket.on("connect", () => {
  console.log("Connected to server as", username);
  socket.emit("register_user", { username });
});

// Handle updated user list
socket.on("update_user_list", (online) => {
  console.log("Online users:", online);
  const ul = document.getElementById("userList");
  ul.innerHTML = "";
  allUsers.forEach(u => {
    if (u.username === username) return; // skip self
    const li = document.createElement("li");
    const isOnline = online.includes(u.username);
    const avatar = u.profile_pic
      ? `<div class="user-avatar"><img src="${u.profile_pic}"></div>`
      : `<div class="user-avatar" style="background:#${hashColor(u.username)}">${u.username.slice(0,2).toUpperCase()}</div>`;
    li.innerHTML = `${avatar}<div>${u.username} ${isOnline ? '🟢' : '⚫'}</div>`;
    li.onclick = () => {
      currentChatUser = u.username;
      localStorage.setItem("lastChatUser", u.username);
      document.getElementById("chatWith").innerText = "Chat with " + u.username;
      loadHistory(u.username);
    };
    ul.appendChild(li);
  });
});

// Hash color helper for initials
function hashColor(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
  let c = (h & 0x00FFFFFF).toString(16).toUpperCase();
  return "00000".substring(0, 6 - c.length) + c;
}

// Load chat history
async function loadHistory(user) {
  if (!user) return;
  const res = await fetch(`/history/${user}`);
  const data = await res.json();
  const box = document.getElementById("messages");
  box.innerHTML = "";
  data.history.forEach(m => appendMessage(m.sender, m.message, m.timestamp));
}

// Append chat message
function appendMessage(sender, text, timestamp) {
  const messagesDiv = document.getElementById("messages");
  const container = document.createElement("div");
  container.className = "message-container" + (sender === username ? " self" : "");
  const msg = document.createElement("div");
  msg.className = "msg " + (sender === username ? "self" : "other");
  msg.innerHTML = `${escapeHtml(text)}<div class="timestamp">${timestamp}</div>`;
  container.appendChild(msg);
  messagesDiv.appendChild(container);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function escapeHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// Send message
document.getElementById("messageForm").addEventListener("submit", (e) => {
  e.preventDefault();
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!currentChatUser || !text) return;
  socket.emit("private_message", { sender: username, to: currentChatUser, message: text });
  input.value = "";
});

// Receive messages
socket.on("new_private_message", (data) => {
  if ((data.sender === currentChatUser && data.receiver === username) ||
      (data.receiver === currentChatUser && data.sender === username)) {
    appendMessage(data.sender, data.message, data.timestamp);
  }
});

// Emoji picker
const emojiBtn = document.getElementById("emojiBtn");
const emojiPicker = document.getElementById("emojiPicker");
const emojiList = ["😀","😁","😂","🤣","😃","😄","😅","😉","😊","😍","😘","😎","🤩","👍","🙏","🔥","🎉"];
emojiBtn.addEventListener("click", () => {
  emojiPicker.style.display = emojiPicker.style.display === "block" ? "none" : "block";
  if (emojiPicker.innerHTML === "") {
    emojiList.forEach(e => {
      const sp = document.createElement("span");
      sp.className = "emoji";
      sp.innerText = e;
      sp.onclick = () => document.getElementById("messageInput").value += e;
      emojiPicker.appendChild(sp);
    });
  }
});
document.addEventListener("click", (e) => {
  if (!emojiPicker.contains(e.target) && e.target !== emojiBtn)
    emojiPicker.style.display = "none";
});

// Restore last chat on load
window.addEventListener("load", () => {
  const last = localStorage.getItem("lastChatUser");
  if (last) {
    setTimeout(() => {
      currentChatUser = last;
      document.getElementById("chatWith").innerText = "Chat with " + last;
      loadHistory(last);
    }, 500);
  }
});
</script>
</body>
</html>
